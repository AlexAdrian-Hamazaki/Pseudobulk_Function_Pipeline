#!/usr/bin/env python3

import sys
import anndata as ad
import pandas as pd


def main():
    tissue_path = sys.argv[1] 
    tissue = sys.argv[2]
    # First, load the tissue
    adata = ad.read_h5ad(tissue_path)
    
    # Make a dict where keys are cell type, and values are average gene expression for that cell type
    dictCellTypeProfile = makeDictCellTypeProfile(adata = adata)
    
    # Make a pandas dataframe from the dictionary
    df = pd.DataFrame(dictCellTypeProfile).T
    # update columns
    df.columns = adata.var_names
    
    # Save the dataframe
    df.to_csv(f"{tissue}_cell_type_profiles.csv")
    
    
    
    


    
def makeDictCellTypeProfile(adata: ad.AnnData) -> dict:
    """Make a dictionary where keys are the cell type, and values is a list of gene expression values
    
    The gene expression values is a cell type profile that is generated by taking the average expression of all of the cells in a cell type

    Args:
        adata_grouped (ad.AnnData): anndata object that is grouped by cell type
        adata (ad.AnnData): anndata object that is not goruped

    Returns:
        dict: Keys are cell types, values are a list of gene expression values
    """
    #Group the anndata by cell type
    adata_grouped = adata.obs.groupby(["Cell type"])
       
    dictCellTypeProfile = {}

    for group, lo_cell_ids in adata_grouped.indices.items():
        
        # Retrive all the cells in a cell type
        grouped_cells = adata[lo_cell_ids,:]
        
        # Summarize the counts for that cell type
        cell_type_profile = grouped_cells.X.mean(axis = 0)
        
        # Add to the dict. key will be the cell type(group) and the value would be a list of summarized genes
        dictCellTypeProfile[group] = cell_type_profile
        
    return dictCellTypeProfile

if __name__ == "__main__":
    main()